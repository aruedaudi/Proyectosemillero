VISTAS SQL

CREATE USER ALBA_CACAO IDENTIFIED BY ALBA_CACAO;
GRANT DBA TO ALBA_CACAO;
CONNECT ALBA_CACAO/ALBA_CACAO;

CREATE TABLE PROVEEDOR (
    ID_PROVEEDOR     NUMBER        PRIMARY KEY,
    NOMBRE           VARCHAR2(100) NOT NULL,
    DIRECCION        VARCHAR2(150) NOT NULL,
    TELEFONO         NUMBER        NOT NULL,
    CORREO           VARCHAR2(100) NOT NULL,
    CIUDAD           VARCHAR2(50)  NOT NULL,
    VEREDA           VARCHAR2(50)  NOT NULL,
    OBSERVACIONES    VARCHAR2(255),
    ACTIVO           CHAR(1)
);

CREATE TABLE PRODUCTO (
    ID_PRODUCTO     NUMBER          PRIMARY KEY,
    DESCRIPCION     VARCHAR2(150)   NOT NULL,
    PESO            FLOAT(126)      NOT NULL,
    ESTADO_CACAO    VARCHAR2(50)    NOT NULL,
    HUMEDAD         FLOAT(126)      NOT NULL,
    FERMENTACION    FLOAT(126)      NOT NULL
);

CREATE TABLE PEDIDO (
    ID_PEDIDO        NUMBER        PRIMARY KEY,
    ID_PROVEEDOR     NUMBER        NOT NULL,
    ID_PRODUCTO      NUMBER        NOT NULL,
    FECHA_ENTREGA    DATE          NOT NULL,
    CANTIDAD         NUMBER        NOT NULL,
    FECHA_CREACION   DATE          NOT NULL,
    RECIBIDO         CHAR(1),
    OBSERVACIONES    VARCHAR2(255),

    CONSTRAINT FK_PEDIDO_PROV FOREIGN KEY(ID_PROVEEDOR)
        REFERENCES PROVEEDOR(ID_PROVEEDOR),

    CONSTRAINT FK_PEDIDO_PROD FOREIGN KEY(ID_PRODUCTO)
        REFERENCES PRODUCTO(ID_PRODUCTO)
);

CREATE TABLE INVENTARIO (
    ID_INVENTARIO   NUMBER PRIMARY KEY,
    ID_PEDIDO       NUMBER NOT NULL,

    CONSTRAINT FK_INV_PED FOREIGN KEY(ID_PEDIDO)
        REFERENCES PEDIDO(ID_PEDIDO)
);

CREATE TABLE BODEGA (
    ID_BODEGA       NUMBER        PRIMARY KEY,
    ID_INVENTARIO   NUMBER        NOT NULL,
    LUGAR           VARCHAR2(100) NOT NULL,
    MOVIMIENTO      VARCHAR2(50)  NOT NULL,

    CONSTRAINT FK_BOD_INV FOREIGN KEY(ID_INVENTARIO)
        REFERENCES INVENTARIO(ID_INVENTARIO)
);


#SE CONFIGURA PARA QUE SI SE AGREGA UNA NUEVA FILA A INVENTARIO, TAMBIEN A BODEGA E IGUALMENTE SI SE ELIMINA.
ALTER TABLE bodega
DROP CONSTRAINT fk_bodega_inventario;

ALTER TABLE bodega
ADD CONSTRAINT fk_bodega_inventario
FOREIGN KEY (id_inventario)
REFERENCES inventario(id_inventario)
ON DELETE CASCADE;


#CREAR VISTA DE LOS DATOS QUE QUEREMOS MOSTRAR EN EL INVENTARIO
CREATE OR REPLACE VIEW vista_inventario AS
SELECT
    i.id_inventario    AS ID,
    pr.descripcion     AS PRODUCTO,
    pd.cantidad        AS CANTIDAD,
    pr.peso            AS PESO,
    pr.estado_cacao    AS ESTADO,
    pr.humedad         AS HUMEDAD,
    pd.fecha_entrega   AS FECHA_ING,
    pv.nombre          AS PROVEEDOR
FROM
    inventario i
    JOIN pedido    pd ON i.id_pedido = pd.id_pedido
    JOIN producto  pr ON pd.id_producto = pr.id_producto
    JOIN proveedor pv ON pd.id_proveedor = pv.id_proveedor
WHERE
    pd.recibido = 'S';


#CREAR VISTA DE LOS DATOS QUE QUEREMOS MOSTRAR EN LA TABLA PEDIDOS
CREATE OR REPLACE VIEW vista_pedidos AS
SELECT 
    id_pedido,
    id_proveedor,
    id_producto,
    fecha_entrega AS fecha_entrada,
    cantidad,
    fecha_creacion,
    recibido,
    observaciones
FROM pedido;


#CREAR VISTA PARA PROVEEDOR MAS FRECUENTE
CREATE OR REPLACE VIEW V_PROVEEDOR_SOLICITADO AS
SELECT
    TRUNC(pe.FECHA_CREACION) AS DIA,
    pv.NOMBRE AS PROVEEDOR,
    COUNT(*) AS VECES
FROM PEDIDO pe
JOIN PROVEEDOR pv ON pv.ID_PROVEEDOR = pe.ID_PROVEEDOR
GROUP BY TRUNC(pe.FECHA_CREACION), pv.NOMBRE;


#CREAR VISTA PARA TOTAL PEDIDOS
CREATE OR REPLACE VIEW V_TOTAL_PEDIDOS AS
SELECT
    TRUNC(FECHA_CREACION) AS DIA,
    COUNT(*) AS TOTAL_PEDIDOS
FROM PEDIDO
GROUP BY TRUNC(FECHA_CREACION);


#SIRVEN PARA AUTOGENERAR LOS ID DE PEDIDO, INVENTARIO Y PROVEEDOR RESPECTIVAMENTE.

CREATE SEQUENCE pedido_seq
START WITH 11
INCREMENT BY 1
NOCACHE;

CREATE SEQUENCE inventario_seq
START WITH 11
INCREMENT BY 1;

CREATE SEQUENCE proveedor_seq
START WITH 6
INCREMENT BY 1
NOCACHE
NOCYCLE;


#PERMITE LA INSERCIÓN DE DATOS EN LA TABLA PEDIDO COMO SI FUESE LA MISMA
CREATE OR REPLACE TRIGGER trg_vista_pedido_insert
INSTEAD OF INSERT ON vista_pedidos
FOR EACH ROW
BEGIN
    INSERT INTO pedido (
        id_pedido,
        id_proveedor,
        id_producto,
        fecha_entrega,
        cantidad,
        fecha_creacion,
        recibido,
        observaciones
    ) VALUES (
        :NEW.id_pedido,
        :NEW.id_proveedor,
        :NEW.id_producto,
        :NEW.fecha_entrada,
        :NEW.cantidad,
        :NEW.fecha_creacion,
        :NEW.recibido,
        :NEW.observaciones
    );
END;
/


#AUTOGENERA EL ID DEL PROVEEDOR Y POR DEFECTO LO ACTIVA
CREATE OR REPLACE TRIGGER trg_proveedor_before_insert
BEFORE INSERT ON proveedor
FOR EACH ROW
DECLARE
    v_next_id NUMBER;
BEGIN
    -- Obtener el siguiente valor de la secuencia
    SELECT proveedor_seq.NEXTVAL INTO v_next_id FROM dual;

    -- Asignar el ID automáticamente
    :NEW.id_proveedor := v_next_id;

    -- Asignar 'S' por defecto al campo ACTIVO
    :NEW.activo := 'S';
END;
/


#CREA UN NUEVO REGISTRO EN EL INVENTARIO CUANDO EL PEDIDO ES RECIBIDO
CREATE OR REPLACE TRIGGER trg_insert_pedido_inventario
AFTER INSERT ON pedido
FOR EACH ROW
WHEN (NEW.recibido = 'S')
BEGIN
    INSERT INTO inventario (id_inventario, id_pedido)
    VALUES (inventario_seq.NEXTVAL, :NEW.id_pedido);
END;
/


#CUANDO EL PEDIDO SE ACTUALIZA A RECIBIDO LO AGREGA AL INVENTARIO
CREATE OR REPLACE TRIGGER trg_update_pedido_inventario
AFTER UPDATE OF recibido ON pedido
FOR EACH ROW
WHEN (NEW.recibido = 'S' AND OLD.recibido <> 'S')
BEGIN
    INSERT INTO inventario (id_inventario, id_pedido)
    VALUES (inventario_seq.NEXTVAL, :NEW.id_pedido);
END;
/


#CUANDO UN NUEVO PEDIDO LLEGA A INVENTARIO LO AGREGA TAMBIEN A BODEGA
CREATE OR REPLACE TRIGGER trg_inventario_bodega
AFTER INSERT ON inventario
FOR EACH ROW
DECLARE
    v_id_bodega NUMBER;
    v_existe NUMBER;
BEGIN
    -- Verifica si ya existe un registro con el mismo id_inventario
    SELECT COUNT(*) INTO v_existe
    FROM bodega
    WHERE id_inventario = :NEW.id_inventario;

    -- Si no existe, se inserta automáticamente
    IF v_existe = 0 THEN
        -- Generamos el nuevo ID_BODEGA
        SELECT NVL(MAX(id_bodega), 0) + 1 INTO v_id_bodega FROM bodega;

        -- Insertamos en la tabla bodega
        INSERT INTO bodega (id_bodega, id_inventario, lugar, movimiento)
        VALUES (v_id_bodega, :NEW.id_inventario, 'Bodega Norte', 'Entrada');
    END IF;
END;
/





